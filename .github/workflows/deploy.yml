name: Deploy API to EC2 (ALB)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout source code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # Setup .NET SDK
      # ---------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ---------------------------
      # Restore dependencies
      # ---------------------------
      - name: Restore
        run: dotnet restore

      # ---------------------------
      # Build application
      # ---------------------------
      - name: Build
        run: dotnet build -c Release --no-restore

      # ---------------------------
      # Apply EF Core migrations (on CI)
      # ---------------------------
      - name: Apply EF Core migrations
        run: |
          dotnet ef database update \
            --project AWSTemplate.Infrastructure \
            --startup-project AWSTemplate.Api

      # ---------------------------
      # Publish application
      # ---------------------------
      - name: Publish
        run: |
          dotnet publish AWSTemplate.Api \
            -c Release \
            -o publish

      # ---------------------------
      # Setup SSH (safe + multi-line key handling)
      # ---------------------------
      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail

          echo "Validating secrets..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "Error: EC2_HOST secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "Error: EC2_USER secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "Error: EC2_SSH_KEY secret is missing"
            exit 1
          fi

          echo "Creating ~/.ssh folder..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "Writing SSH private key..."
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "Adding EC2 host to known_hosts..."
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts || true

      # ---------------------------
      # Ensure remote directory exists
      # ---------------------------
      - name: Ensure remote directory exists
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            mkdir -p ~/awstemplate
          EOF

      # ---------------------------
      # Copy published files to EC2
      # ---------------------------
      - name: Copy files to EC2
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" publish/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/awstemplate/

      # ---------------------------
      # Restart API service
      # ---------------------------
      - name: Restart API service
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            # Перезапуск systemd сервиса (если настроен)
            sudo systemctl restart awstemplate-api || true
          EOF
