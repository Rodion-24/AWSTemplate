- name: Setup SSH
  shell: bash
  run: |
    set -e

    # Check secrets
    if [ -z "${{ secrets.EC2_HOST }}" ]; then
      echo "EC2_HOST secret is missing"
      exit 1
    fi

    if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
      echo "EC2_SSH_KEY secret is missing"
      exit 1
    fi

    # Create SSH directory
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    # Write multi-line key safely
    echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa

    # Add host to known_hosts
    ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
