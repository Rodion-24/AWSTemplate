name: Deploy API to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout source code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # Setup .NET SDK
      # ---------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ---------------------------
      # Build and publish application
      # ---------------------------
      - name: Build & Publish
        run: |
          dotnet restore
          dotnet build -c Release --no-restore
          dotnet publish AWSTemplate.Api -c Release -o publish
      # ---------------------------
      # Setup SSH
      # ---------------------------
      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts || true
      # ---------------------------
      # Ensure remote directory exists
      # ---------------------------
      - name: Ensure remote directory exists
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            mkdir -p ~/awstemplate
          EOF
      # ---------------------------
      # Copy published files to EC2
      # ---------------------------
      - name: Copy files to EC2
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" publish/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/awstemplate/
      # ---------------------------
      # Restart API service
      # ---------------------------
      - name: Restart API service
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            # Перезапуск systemd сервиса, если он есть
            sudo systemctl restart awstemplate-api || true
          EOF
