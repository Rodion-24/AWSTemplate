name: Deploy API to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout source code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # Setup .NET SDK
      # ---------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ---------------------------
      # Build and publish application
      # ---------------------------
      - name: Build & Publish
        run: |
          dotnet restore
          dotnet build -c Release --no-restore
          dotnet publish AWSTemplate.Api -c Release -o publish

      # ---------------------------
      # Setup SSH
      # ---------------------------
      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts || true

      # ---------------------------
      # Ensure remote directory exists
      # ---------------------------
      - name: Ensure remote directory exists
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            mkdir -p ~/awstemplate
          EOF

      # ---------------------------
      # Copy published files to EC2
      # ---------------------------
      - name: Copy files to EC2
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" publish/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/awstemplate/

      # ---------------------------
      # Setup systemd service if not exists
      # ---------------------------
      - name: Ensure systemd service
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail

            SERVICE_FILE=/etc/systemd/system/awstemplate-api.service

            if [ ! -f "$SERVICE_FILE" ]; then
              echo "Creating systemd service for AWSTemplate API..."
              sudo tee $SERVICE_FILE > /dev/null << 'EOL'
[Unit]
Description=AWSTemplate API
After=network.target

[Service]
WorkingDirectory=/home/ec2-user/awstemplate
ExecStart=/usr/bin/dotnet /home/ec2-user/awstemplate/AWSTemplate.Api.dll
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=awstemplate-api
User=ec2-user
Environment=ASPNETCORE_ENVIRONMENT=Production

[Install]
WantedBy=multi-user.target
EOL
              sudo systemctl daemon-reload
              sudo systemctl enable awstemplate-api
            fi
          EOF

      # ---------------------------
      # Restart API service
      # ---------------------------
      - name: Restart API service
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -euo pipefail
            sudo systemctl restart awstemplate-api
          EOF
